<section *ngIf="!isLoading">
    <div class="closePicker" *ngIf="emojiWindowOpen" (click)="toggleEmojis()"></div>
    <div class="chat-box">
        <!-------------------------------------Chat Head-------------------------------------->
        <div class="thread-head">
            <div class="left-side-head">
                <h3>Thread</h3>
                <img src="/assets/img/tagPurple.svg" alt="Purple Hashtag">
                <p>Entwicklerteam</p>
            </div>
            <button (click)="closeThread()" class="close-button"></button>
        </div>
        <!-----------------------------------Chat Head------------------------------------>
        <!---------------------------------------Chat Content--------------------------------------->
        <div #chatContent class="chat-content">
            @if (currentUser !== firstThreadMessage.createdBy) {
            <div *ngIf="firstThreadMessage" class="user-message"> <!-- Thread Message -->
                <img class="profile-picture" src="/assets/img/userImages/userImage4.svg" alt="">
                <div>
                    <div class="user-time">
                        <p>{{ getUserName(firstThreadMessage.createdBy) }}</p>
                        <span>{{ firstThreadMessage.creationDate | date:'HH:mm' }} Uhr</span>
                    </div>
                    <div class="thread-message">
                        <span>{{ firstThreadMessage.message }}</span>
                    </div>
                </div>
            </div>
            } @else {
            <div *ngIf="firstThreadMessage" class="user-message own-message">
                <img class="profile-picture" src="/assets/img/userImages/userImage6.svg" alt="">
                <div>
                    <div class="user-time own-message">
                        <p>{{ getUserName(firstThreadMessage.createdBy) }}</p>
                        <span>{{ firstThreadMessage.creationDate | date:'HH:mm' }} Uhr</span>
                    </div>
                    <div class="thread-message own-bubble">
                        <span>{{ firstThreadMessage.message }}</span>
                    </div>
                </div>
            </div>
            }

            <div class="answer-line-container"> <!-- Marker for seperate thread quiry to answers -->
                <p>{{ threadMessages.length }} Antworten</p>
                <div class="purple-line"></div>
            </div>
            <!-------------------- Template of others awnsers ------------------------>
            @for (message of threadMessages; track $index) {
            @if(currentUser !== threadMessages[$index].createdBy){
            <div class="user-message">
                <img class="profile-picture" src="/assets/img/userImages/userImage5.svg" alt="">
                <div>
                    <div class="user-time">
                        <p>{{ getUserName(message.createdBy) }}</p>
                        <span>{{ message.creationDate | date:'HH:mm' }} Uhr</span>
                    </div>
                    <div class="thread-message">
                        <span>{{ message.message }}</span>
                    </div>
                    <app-reactions-secondary [userId]="message.createdBy" [messageId]="message.messageId" [reactionCollectionPath]="reactionCollectionPath" [currentUser]="currentUser">
                </app-reactions-secondary>
                </div>
                <div class="action-bar" (click)="openMoreEmojis(message.messageId)">
                    <button class="add-reaction" alt=""></button>
                </div>

                <app-reaction-emoji-input 
                class="reactionOtherMessages" 
                *ngIf="showMoreEmojis[message.messageId]" 
                [showMoreEmojis]="showMoreEmojis[message.messageId]" 
                (showMoreEmojisChild)="closeMoreEmojis(message.messageId)"
                [reactionCollectionPath]="reactionCollectionPath" 
                [currentUser]="currentUser"
                [reactions]="reactions" 
                [messageId]="message.messageId">
                </app-reaction-emoji-input>
            </div>
            } @else {
            <!-------------------- Template of own message ------------------------>
            <div class="user-message own-message">
                <img class="profile-picture" src="/assets/img/userImages/userImage6.svg" alt="">
                <div class="message-box">
                    <div class="user-time own-message">
                        <p>{{ getUserName(message.createdBy) }}</p>
                        <span>{{ message.creationDate | date:'HH:mm' }} Uhr</span>
                    </div>
                    <div class="thread-message own-bubble">

                        <div *ngIf="editingMessageId === message.messageId && !openEditOwnMessage; else displayMessage">
                            <input class="edit-message-input" [(ngModel)]="editingMessageText"
                                (keyup.enter)="saveMessageChanges()" type="text">
                        </div>
                        <ng-template #displayMessage>
                            <span>{{ message.message }}</span>
                        </ng-template>
                    </div>
                    <app-reactions-secondary [userId]="message.createdBy" [messageId]="message.messageId" [reactionCollectionPath]="reactionCollectionPath" [currentUser]="currentUser">
                    </app-reactions-secondary>
                </div>
                <div class="own-action-bar">
                    <button class="add-reaction" (click)="openMoreEmojis(message.messageId)" alt=""></button>
                    <button class="options" (click)="openEditOwnMessageField(message.messageId)"
                        alt="Optionen"></button>
                </div>

                <app-reaction-emoji-input 
                class="reactionOtherMessages" 
                *ngIf="showMoreEmojis[message.messageId]" 
                [showMoreEmojis]="showMoreEmojis[message.messageId]" 
                (showMoreEmojisChild)="closeMoreEmojis(message.messageId)"
                [reactionCollectionPath]="reactionCollectionPath" 
                [currentUser]="currentUser"
                [reactions]="reactions" 
                [messageId]="message.messageId">
                </app-reaction-emoji-input>

                <div *ngIf="editingMessageId === message.messageId && openEditOwnMessage"
                    (click)="startEditMessage(message)" class="edit-message">
                    <span>Nachricht bearbeiten</span>
                </div>
            </div>
            }}
        </div>
        <!--------------------------------------Chat Content-------------------------------------->
        <!--------------------------------------Input Contnent-------------------------------------->
        <div class="input-content" (click)="message.focus()">

            <textarea (keydown.enter)="sendMessage()" #message [(ngModel)]="messageModel" (input)="updateCursorPosition($event)"
                placeholder="Antworten..." name="second-chat-input" cols="30" rows="10">
          </textarea>

            <div class="action-icons-container">

                <div class="left-actions">
                    <button class="add-button"></button>
                    <img src="/assets/img/main-chat/separatingLine.svg">
                    <button (click)="toggleEmojis()" class="emoji-button"></button>

                    <emoji-mart #emojiPicker *ngIf="emojiWindowOpen" class="emoji-mart"
                        (emojiSelect)="onEmojiSelect($event)" title="Pick your emojiâ€¦" emoji="point_up">
                    </emoji-mart>

                    <button class="tag-button"></button>
                </div>
                <button class="send-button" (click)="sendMessage()"></button>
            </div>
        </div>
        <!--------------------------------------Input Contnent-------------------------------------->
    </div>
</section>